首要来源：PX4       来源：北航－全权－中国MOCC


### 四元数与机体角速度的关系

常见的表示三维旋转有欧拉角、旋转矩阵和四元数三种方法，在这里我们只描述用四元数表示机体旋转的方法，因为其被大多数商业使用：

在PX4中可以选择融合地磁或加速度以辅助姿态估计，但我们在这里突出四元数表达角度，所以忽略这俩个补偿

```
	// Feed forward gyro
	corr += _rates;

	// Apply correction to state
	_q += _q.derivative1(corr) * dt;
```

代码如上，将机体坐标系下的角速率传递给四元数进行微分处理。注意每次求解的都是角度增量变化。

```
    Matrix41 derivative1(const Matrix31 &w) const
    {
        const Quaternion &q = *this;
        Quaternion<Type> v(0, w(0, 0), w(1, 0), w(2, 0));
        return q * v  * Type(0.5);
    }
```
上面代码(用机体角速度更新四元数)根据下图计算，四元数与机体角速度的关系：

![IMAGE ALT TEXT HERE](https://github.com/xdwgood/Navigation-and-control/blob/xdwgood-patch-1/176.png)
